
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TODO: Come Up With Clever Title</title>
  <meta name="author" content="Charles Johnson">

  
  <meta name="description" content="It&#8217;s a little puzzling to me that while Chef has the remote_file resource for copying files from remote hosts to local, it doesn&#8217;t have a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://charlesjohnson.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="TODO: Come Up With Clever Title" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39252608-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">TODO: Come Up With Clever Title</a></h1>
  
    <h2>What's a little technical debt between friends?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:charlesjohnson.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/12/copying-files-as-part-of-a-chef-recipe/">Copying Files as Part of a Chef Recipe</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-12T16:54:00-07:00" pubdate data-updated="true">Mar 12<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/03/12/copying-files-as-part-of-a-chef-recipe/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s a little puzzling to me that while Chef has the <a href="http://docs.opscode.com/chef/resources.html#remote_file">remote_file</a> resource for copying files from remote hosts to local, it doesn&#8217;t have a similar mechanism in the <a href="http://docs.opscode.com/chef/resources.html#remote_file">file</a> resource to allow for copying files from one local location to another as part of a recipe. As a deploy pattern unnecessary file copies should be discouraged, but sometimes it&#8217;s just necessary to copy a file once it&#8217;s been placed on the system by an outside actor. One good example of this situation is when using a <a href="http://www.vagrantup.com">Vagrant</a> guest with the <a href="http://docs-v1.vagrantup.com/v1/docs/provisioners/chef_server.html">Chef-Server</a> provisioner and the <a href="http://community.opscode.com/cookbooks/chef-client">chef-client</a> cookbook.</p>

<p>When run without any flags, chef-client looks for configuration at the default location, <code>/etc/chef/client.rb</code>. However, when Vagrant starts a run using the Chef-Server provisioner, it writes out a <code>client.rb</code> file to the guest at <code>/tmp/vagrant-chef-1/client.rb</code>, and then starts a single run of chef-client with the <code>-c /tmp/vagrant-chef-1/client.rb</code> command-line flag, telling it to look for the config file in the irregular location.</p>

<p>But what if the recipe being tested with Vagrant adds <code>recipe[chef-client::service]</code> to the node&#8217;s run_list? Vagrant will start an instance of chef-client, using the Vagrant-generated client.rb file at <code>/tmp/vagrant-chef-1/client.rb</code>. When this copy of chef-client runs the chef-client::service recipe, the Vagrant-instantiated copy of chef-client will try to start a second, daemonized copy of chef-client as a service, this time without the -c flag. The second copy of chef-client will look for the config file at <code>/etc/chef/client.rb</code>, but because no config file has been placed there, the provisioner will exit with an error.</p>

<p>This makes it tricky to use Vagrant to test code that starts Chef-client as a service, because Vagrant writes out the <code>client.rb</code> file to /tmp, which isn&#8217;t a suitable place to hold long-term data in any environment. Unlike Vagrant&#8217;s <a href="http://docs-v1.vagrantup.com/v1/docs/provisioners/chef_solo.html">Chef-Solo</a> provisioner, it&#8217;s impossible to inject node attributes directly via the Vagrantfile with the Chef-Server provisioner, so we can&#8217;t easily write an exception into the Vagrantfile itself. Either a more complicated workflow must be devised to set the <code>["chef_client"]["conf_dir"]</code> attribute to point to <code>/tmp/vagrant-chef-1</code>, or (more simply) the client.rb file should be copied to <code>/etc/chef/client.rb</code> prior to running the <code>chef-client::service</code> recipe.</p>

<p>Here&#8217;s a code block that should take care of this use case, with values hard-coded for readability:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s2">&quot;/tmp/vagrant-chef-1/client.rb&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ruby_block</span> <span class="s2">&quot;copy Chef config file if running in a Vagrant guest&quot;</span> <span class="k">do</span>
</span><span class='line'>   <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">::</span><span class="no">FileUtils</span><span class="o">.</span><span class="n">cp</span> <span class="s2">&quot;/tmp/vagrant-chef-1/client.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/chef/client.rb&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s2">&quot;/etc/chef/client.rb&quot;</span><span class="p">)</span>
</span><span class='line'>     <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">FileUtils</span><span class="o">.</span><span class="n">compare_file</span><span class="p">(</span><span class="s2">&quot;/tmp/vagrant-chef-1/client.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/chef/client.rb&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this does: First check to see if the source file exists. If it does, check to see if the target file exists. If both files exist, then compare them to see if they are identical. If the files are not identical, or if the target file does not exist, then copy the source file to the target file location, overwriting the target file if present. In all other cases, do nothing.</p>

<p>Drop this in before the <code>chef-client::service</code> recipe, and the Vagrant provision run will now complete, because the Chef-client service will be able to start from recipe.</p>

<p>One note: While I haven&#8217;t done any direct testing, it looks like Ruby&#8217;s <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/fileutils/rdoc/FileUtils.html#method-c-compare_file_">FileUtils.compare_file()</a> method works by streaming both files and comparing them, so it should work with binaries. However, I could imagine this being very memory-hungry if attempted with large files. Or maybe not? I&#8217;m a lousy Rubyist.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/5aef5f1a09643f748ab29690668a9d30" alt="Gravatar of Charles Johnson " title="Gravatar of Charles Johnson" />
	</span>
</section>

Included file &#8216;custom/asides/twitteraboutme.html&#8217; not found in _includes directory<section>
  <h1>About Me</h1>
  <p>Professional Opscode Chef enthusiast by day, not-computer-things by night.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/12/copying-files-as-part-of-a-chef-recipe/">Copying Files as Part of a Chef Recipe</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/charlesjohnson">@charlesjohnson</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'charlesjohnson',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Charles Johnson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chipadeedoodah';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
